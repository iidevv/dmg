<footer class="footer">
    <span class="dmg-decor-top"></span>
    <div class="container">
        <div class="themevale_topFooter">
            <h4 class="text">{{theme_settings.footer-top-content}}</h4>
            <a class="phone" href="tel:{{theme_settings.footer-top-button}}">{{theme_settings.footer-top-button}}</a>
        </div>
        <div class="themevale_middleFooter">
            <div class="footer-info themevale_footer-info col-5">
                <div class="footer-info-col" data-section-type="newsletterSubscription">
                    <div class="item">
                        {{#if settings.show_newsletter_box}}
                        {{> components/common/subscription-form}}
                        {{/if}}
                    </div>
                    <div class="item">
                        {{> components/common/social-links}}
                    </div>
                </div>
                <div class="footer-info-col footer-info-col--small footer-dropdownmobile"
                    data-section-type="footer-categories">
                    <h5 class="footer-info-heading">
                        <span>{{lang 'footer.shop'}}</span>
                        <svg class="icon-dropdown">
                            <use xlink:href="#icon-chevron-down"></use>
                        </svg>
                    </h5>
                    <ul class="footer-info-list">
                        {{#each (limit categories 9)}}
                        <li>
                            <a href="{{url}}">{{name}}</a>
                        </li>
                        {{/each}}
                    </ul>
                </div>
                <div class="footer-info-col footer-info-col--small footer-dropdownmobile"
                    data-section-type="footer-webPages">
                    <h5 class="footer-info-heading">
                        <span>{{lang 'footer.info'}}</span>
                        <svg class="icon-dropdown">
                            <use xlink:href="#icon-chevron-down"></use>
                        </svg>
                    </h5>
                    <ul class="footer-info-list">
                        {{#each (limit pages 9)}}
                        <li>
                            <a href="{{url}}">{{name}}</a>
                        </li>
                        {{/each}}
                    </ul>
                </div>
                <div class="footer-info-col footer-info-col--small footer-dropdownmobile">
                    <h5 class="footer-info-heading">
                        <span>{{lang 'footer.contact'}}</span>
                        <svg class="icon-dropdown">
                            <use xlink:href="#icon-chevron-down"></use>
                        </svg>
                    </h5>
                    <ul class="footer-info-list">
                        <li class="store-address"><svg class="icon">
                                <use xlink:href="#icon-location-2"></use>
                            </svg>
                            <a target="_blank" href="https://goo.gl/maps/GG3Q3NpL1C2NU8FX8">
                                18001 Sky Park Cir,<br> Irvine, CA 92614
                            </a>
                        </li>
                        <li class="store-phone"><svg class="icon">
                                <use xlink:href="#icon-telephone-2"></use>
                            </svg>
                            <a href="tel:{{theme_settings.footer-top-button}}">{{theme_settings.footer-top-button}}</a>
                            <a class="ask_an_expert" href="#" data-reveal-id="ask-an-expert">{{lang
                                'footer.ask_an_expert'}}</a>
                        </li>
                        <li class="store-email"><svg class="icon">
                                <use xlink:href="#icon-envelope-2"></use>
                            </svg><a href="mailto:{{theme_settings.footer-middle-email}}">
                                {{theme_settings.footer-middle-email}}</a></li>
                    </ul>
                    <ul class="socials-list">
                        <li>
                            <a href="https://www.facebook.com/111351138160622" target="_blank"
                                rel="noopener noreferrer">
                                <svg viewBox="0 0 24 24" fill="currentColor" width="34px" height="34px">
                                    <path fill-rule="evenodd"
                                        d="M22 12.061C22 6.505 17.523 2 12 2S2 6.505 2 12.061c0 5.022 3.657 9.184 8.438 9.939v-7.03h-2.54v-2.91h2.54V9.845c0-2.522 1.492-3.915 3.777-3.915 1.094 0 2.238.197 2.238.197v2.476h-1.26c-1.243 0-1.63.775-1.63 1.57v1.888h2.773l-.443 2.908h-2.33V22c4.78-.755 8.437-4.917 8.437-9.939z">
                                    </path>
                                </svg>
                            </a>
                        </li>
                        <li>
                            <a href="https://www.instagram.com/discount_moto_gear" target="_blank"
                                rel="noopener noreferrer">
                                <svg viewBox="0 0 24 24" fill="currentColor" width="34px" height="34px">
                                    <path
                                        d="M16.604 8.516c.13.35.198.719.203 1.091.033.622.033.811.033 2.386 0 1.574-.004 1.763-.033 2.385a3.273 3.273 0 0 1-.203 1.091 1.956 1.956 0 0 1-1.12 1.12c-.35.13-.719.198-1.091.204-.622.032-.811.032-2.386.032-1.574 0-1.763-.003-2.385-.032a3.273 3.273 0 0 1-1.091-.204 1.956 1.956 0 0 1-1.12-1.12 3.273 3.273 0 0 1-.204-1.09c-.032-.623-.032-.812-.032-2.386 0-1.575.003-1.764.032-2.386.006-.372.074-.741.204-1.09a1.956 1.956 0 0 1 1.12-1.12c.35-.13.718-.199 1.09-.204.623-.033.812-.033 2.386-.033 1.575 0 1.764.004 2.386.033.372.005.741.074 1.09.203.515.2.922.606 1.12 1.12zM12 15.033a3.033 3.033 0 1 0 0-6.066 3.033 3.033 0 0 0 0 6.066zm3.153-5.477a.71.71 0 1 0 0-1.418.71.71 0 0 0 0 1.418zM12 13.967a1.967 1.967 0 1 1 0-3.934 1.967 1.967 0 0 1 0 3.934zM12 2C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10A10 10 0 0 0 12 2zm5.87 12.433c-.01.49-.102.974-.274 1.432a3.018 3.018 0 0 1-1.727 1.728 4.335 4.335 0 0 1-1.433.272c-.629.03-.829.037-2.432.037-1.604 0-1.819 0-2.433-.037a4.335 4.335 0 0 1-1.433-.272 3.018 3.018 0 0 1-1.727-1.728 4.335 4.335 0 0 1-.273-1.432c-.029-.63-.036-.83-.036-2.433 0-1.604 0-1.818.036-2.433.01-.49.102-.974.273-1.432a3.018 3.018 0 0 1 1.727-1.728 4.335 4.335 0 0 1 1.433-.272c.629-.03.829-.037 2.433-.037 1.603 0 1.818 0 2.432.037.49.009.974.101 1.433.272.794.307 1.42.934 1.727 1.728.172.458.264.943.273 1.432.03.63.036.83.036 2.433 0 1.604-.007 1.804-.036 2.433z">
                                    </path>
                                </svg>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="themevale_bottomFooter">
        <div class="container themevale_bottomFooter_container">
            <div class="item">
                {{#if theme_settings.show_copyright_footer}}
                <div class="footer-copyright">
                    <p class="powered-by">Copyright &copy; {{moment format="YYYY"}} {{settings.store_name}} - All Rights
                        Reserved.</p>
                </div>
                {{/if}}
            </div>
            <div class="item">
                {{> components/common/payment-icons}}
            </div>
        </div>
    </div>
</footer>
{{#if theme_settings.themevale_BackTop}}
<div id="back-to-top">
    <a href="javascript:void(0)"><svg class="icon">
            <use xlink:href="#icon-keyboard-arrow-down"></use>
        </svg></a>
</div>
{{/if}}


{{#if theme_settings.themevale_ask-an-expert}}
{{> components/themevale/ask-an-expert}}
{{/if}}

{{#if theme_settings.themevale_RecentlyBought}}
<div class="themevale_popup_left"></div>
{{/if}}

{{#if settings.privacy_cookie }}
<div class="themevale_popup_right">
    {{> components/common/cookie }}
</div>
{{/if}}
<script>
    document.addEventListener('DOMContentLoaded', () => {

        if (!document.querySelector("#ymm-results")) return;
        // page template
        // <div id="ymm-results">
        //     <div class="ymm-filters"></div>
        //     <div class="ymm-products"></div>
        // </div>

        (async () => {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);

            const ymmResults = document.querySelector("#ymm-results");
            const ymmFilters = document.querySelector("#ymm-results .ymm-filters");
            const ymmProducts = document.querySelector("#ymm-results .ymm-products");

            const hash = urlParams.get('hash');
            const year = urlParams.get('year');
            const make = urlParams.get('make');
            const model = urlParams.get('model');
            let page = 0;
            let totalPages = 0;
            const pageTitle = document.querySelector('.page-heading');
            pageTitle.textContent = `Search Results for: ${year} - ${make} ${model}`;

            ymmResults.addEventListener('click', async (e) => {
                if (!e.target.classList.contains('ymm-product-link')) return;
                e.preventDefault();
                let productLink = e.target;
                const sku = productLink.dataset.productId;
                productLink.textContent = 'Loading...';
                const response = await fetch(`https://warehouse.discountmotogear.com/api/external/product?sku=${sku}`, {
                    method: "GET",
                    headers: {
                        "Content-Type": "application/json"
                    },
                });
                if (response.link) window.location.href = response.link;
                if (response.error) productLink.textContent = 'Error.';
            });


            const createProduct = (data) => {
                const brand = data.brandName;
                const name = data.description;
                const sku = data.partNumber;
                const image = data.primaryMedia.absoluteUrl.replace('http:', 'https:');
                const stock = data.inventory.locales.reduce(
                    (total, local) => total + (local.quantity || 0),
                    0
                );
                const price =
                    data.prices.retail ||
                    data.prices.originalRetail ||
                    data.prices.originalBase + data.prices.originalBase * 0.35;
                let addToCart;
                if (stock > 0) {
                    addToCart = `<a href="#" data-event-type="product-click" class="ymm-product-link button card-figcaption-button" data-product-id="${sku}" tabindex="0">Add To Cart</a>`;
                } else {
                    addToCart = `<a href="#" data-reveal-id="ask-an-expert" class="button card-figcaption-button" data-product-id="${sku}" tabindex="0">Ask An Expert</a>`;
                }

                return `
                        <li class="product">
                          <article class="card" data-product-id="${sku}">
                          <div class="card-figure">
                              <img style="width: 100%; height: 285px; object-fit: contain;" src="${image}" alt="${name}"/>
                          </div>
                          <div class="card-body">
                            <p class="card-brand" data-test-info-type="brandName">${brand}</p>
                            <p class="card-sku">#${sku}</p>
                            <h4 class="card-title">
                            ${name}
                            </h4>
                            <div class="card-wrapper">
                            <span data-product-price-without-tax="" class="price price--withoutTax">$${price}</span>
                            </div>
                            <div class="card-figcaption">
                                ${addToCart}
                            </div>
                          </div>
                          </article>
                        </li>
                      `;
            }

            const getProducts = async (hash, search, page) => {
                try {
                    const offset = page * 20;
                    const payload = {
                        queryString: search,
                        filters: [
                            {
                                "operator": "OR",
                                "matches": [
                                    {
                                        "parameters": {
                                            "precision": "exact"
                                        },
                                        "type": "fitmentPrecision",
                                        "valueMatchMethod": "EXACT"
                                    }
                                ]
                            },
                            {
                                "operator": "OR",
                                "matches": [
                                    {
                                        "path": "fitments",
                                        "values": [
                                            hash
                                        ]
                                    }
                                ]
                            }
                        ],
                        pagination: {
                            limit: 20,
                            "offset": offset
                        },

                    };
                    const response = await fetch('https://www.parts-unlimited.com/api/parts/search', {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "access-control-allow-origin": "*",
                        },
                        body: JSON.stringify(payload),
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const products = data.result.hits.map(product => createProduct(product)).join('');
                        totalPages = Math.ceil(data.result.total / 20);

                        return products;
                    } else {
                        console.log("Error:" + response.status);
                    }
                } catch (error) {
                    console.log(error);
                }
            }

            const getPagination = (page, totalPages) => {

                let prevPage = `
                    <li class="pagination-item pagination-item--previous">
                        <a id="prev-page" class="pagination-link" href="#" data-faceted-search-facet="">
                            <i class="icon" aria-hidden="true">
                                <svg>
                                    <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-slick-prev"></use>
                                </svg>
                            </i>
                            Previous
                        </a>
                    </li>
                `;
                let nextPage = `
                    <li class="pagination-item pagination-item--next">
                        <a id="next-page" class="pagination-link" href="#" data-faceted-search-facet="">
                            Next
                            <i class="icon" aria-hidden="true">
                                <svg>
                                    <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-slick-next"></use>
                                </svg>
                            </i>
                        </a>
                    </li>`;

                if (page == 0) {
                    prevPage = '';
                }

                if (page + 1 == totalPages) {
                    nextPage = '';
                }

                return `<ul class="pagination-list">${prevPage}${nextPage}</ul>`;
            }

            const onPageChanged = async (hash, page) => {
                const search = document.querySelector('#ymm-search-input').value;
                await getYmmContent(hash, search, page);
            }

            const getSearchResults = async (hash, search, page) => {
                if (search.length > 2) await getYmmContent(hash, search, page);
                if (search.length == 0) await getYmmContent(hash, search, page);
            }


            const getYmmContent = async (hash, search, page) => {
                const products = await getProducts(hash, search, page);
                const pagination = getPagination(page, totalPages);
                if (products) {
                    ymmProducts.innerHTML = `<ul class="productGrid">${products}</ul>${pagination}`;
                    if (document.querySelector('#prev-page')) document.querySelector('#prev-page').addEventListener('click', (e) => { onPageChanged(hash, page - 1) });
                    if (document.querySelector('#next-page')) document.querySelector('#next-page').addEventListener('click', (e) => { onPageChanged(hash, page + 1) });
                } else {
                    ymmProducts.innerHTML = `Not found!`
                }
            }

            const ymmSearch = `<input id="ymm-search-input" placeholder="Enter part name or number..."/>`;
            ymmFilters.innerHTML = ymmSearch;
            document.querySelector('#ymm-search-input').addEventListener('input', (e) => { getSearchResults(hash, e.target.value, page) });

            getYmmContent(hash, "", page);
        })();
    });
</script>